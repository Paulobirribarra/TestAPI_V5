<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Consultar Facturas</title>
    <link rel="stylesheet" href="/css/styles.css" />
    <style>
        #mensajeExito {
            background-color: #28a745;
            color: white;
            padding: 10px;
            margin-top: 20px;
            text-align: center;
            border-radius: 5px;
            display: none;
        }
        #mensajeError {
            background-color: #dc3545;
            color: white;
            padding: 10px;
            margin-top: 20px;
            text-align: center;
            border-radius: 5px;
            display: none;
        }
        #loadingIcon {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        #loadingIcon img {
            width: 50px;
            height: 50px;
        }
    </style>
</head>
<body>
    <%- include('partials/header') %>

    <main class="container">
        <h1>Consultar Facturas</h1>

        <form id="consulta-form">
            <label for="tipoConsulta">Tipo de Consulta:</label>
            <select id="tipoConsulta">
                <option value="dia">Por D√≠a</option>
                <option value="mes">Por Mes</option>
            </select>

            <div id="fecha-container">
                <label for="fecha">Selecciona una Fecha:</label>
                <input type="date" id="fecha" />
            </div>

            <div id="mes-container" style="display: none;">
                <label for="mes">Mes:</label>
                <input type="month" id="mes" />
            </div>

            <button type="submit">Consultar</button>
        </form>

        <div id="loadingIcon">
            <img src="/img/loading-icon.gif" alt="Cargando..." />
        </div>

        <div id="mensajeExito">
            ‚úÖ Consulta realizada con √©xito.
        </div>

        <div id="mensajeError">
            ‚ùå Error en la consulta. Int√©ntalo de nuevo.
        </div>

        <section class="facturas" id="resultado">
            <!-- Aqu√≠ se mostrar√°n las facturas din√°micamente -->
        </section>
    </main>

    <script>
        document.getElementById('tipoConsulta').addEventListener('change', function () {
            const tipo = this.value;
            document.getElementById('fecha-container').style.display = tipo === 'dia' ? 'block' : 'none';
            document.getElementById('mes-container').style.display = tipo === 'mes' ? 'block' : 'none';
        });

        async function fetchConTimeout(url, timeout = 20000) {
            const controlador = new AbortController();
            const id = setTimeout(() => controlador.abort(), timeout);
            try {
                const response = await fetch(url, { signal: controlador.signal });
                clearTimeout(id);
                return response;
            } catch (error) {
                console.error("üö® Timeout o error de red:", error);
                throw new Error("La consulta tard√≥ demasiado. Int√©ntalo de nuevo.");
            }
        }

        document.getElementById('consulta-form').addEventListener('submit', async function(event) {
            event.preventDefault();

            const tipo = document.getElementById('tipoConsulta').value;
            let url = '/api/consulta';

            document.getElementById('loadingIcon').style.display = 'block';
            document.getElementById('mensajeExito').style.display = 'none';
            document.getElementById('mensajeError').style.display = 'none';
            document.getElementById('resultado').innerHTML = '';

            try {
                if (tipo === 'dia') {
                    const fecha = document.getElementById('fecha').value;
                    if (!fecha) {
                        alert("Por favor, selecciona una fecha.");
                        return;
                    }
                    url += `?fecha=${fecha}`;
                } else {
                    const mes = document.getElementById('mes').value;
                    if (!mes) {
                        alert("Por favor, selecciona un mes.");
                        return;
                    }
                    const [anio, mesNum] = mes.split('-');
                    url += `?mes=${mesNum}&anio=${anio}`;
                }

                const response = await fetchConTimeout(url, 20000);
                const data = await response.json();

                console.log("‚úÖ Respuesta JSON recibida:", data);

                if (response.ok && data.consultaRealizada && data.facturas.length > 0) {
                    document.getElementById('mensajeExito').style.display = 'block';

                    // Generar HTML para mostrar las facturas
                    const facturasHTML = data.facturas.map(factura => `
                        <div class="factura-card">
                            <h2>Folio: ${factura.folio}</h2>
                            <p><strong>Raz√≥n Social:</strong> ${factura.razonSocial}</p>
                            <p><strong>RUT Cliente:</strong> ${factura.rutCliente}</p>
                            <p><strong>Fecha Emisi√≥n:</strong> ${new Date(factura.fechaEmision).toDateString()}</p>
                            <p><strong>Monto Total:</strong> $${factura.montoTotal.toLocaleString()}</p>
                            <p><strong>Estado:</strong> ${factura.estado}</p>
                        </div>
                    `).join('');

                    document.getElementById('resultado').innerHTML = `<div class="factura-grid">${facturasHTML}</div>`;
                } else {
                    throw new Error(data.error || "No se encontraron facturas.");
                }
            } catch (error) {
                console.error("‚ùå Error en la consulta:", error);
                document.getElementById('mensajeError').style.display = 'block';
                document.getElementById('resultado').innerHTML = `<p style="color: red;">${error.message}</p>`;
            } finally {
                document.getElementById('loadingIcon').style.display = 'none';
            }
        });
    </script>

    <%- include('partials/footer') %>
</body>
</html>