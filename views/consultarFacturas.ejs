<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Consultar Facturas</title>
    <link rel="stylesheet" href="/css/styles.css" />
    <style>
        #mensajeExito {
            background-color: #28a745;
            color: white;
            padding: 10px;
            margin-top: 20px;
            text-align: center;
            border-radius: 5px;
            display: none;
        }
        #mensajeError {
            background-color: #dc3545;
            color: white;
            padding: 10px;
            margin-top: 20px;
            text-align: center;
            border-radius: 5px;
            display: none;
        }
        #loadingIcon {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        #loadingIcon img {
            width: 50px;
            height: 50px;
        }
    </style>
</head>
<body>
    <%- include('partials/header') %>

    <main class="container">
        <h1>Consultar Facturas</h1>

        <form id="consulta-form">
            <label for="tipoConsulta">Tipo de Consulta:</label>
            <select id="tipoConsulta">
                <option value="dia">Por D√≠a</option>
                <option value="mes">Por Mes</option>
            </select>

            <div id="fecha-container">
                <label for="fecha">Selecciona una Fecha:</label>
                <input type="date" id="fecha" />
            </div>

            <div id="mes-container" style="display: none;">
                <label for="mes">Mes:</label>
                <input type="month" id="mes" />
            </div>

            <button type="submit">Consultar</button>
        </form>

        <div id="loadingIcon">
            <img src="/img/loading-icon.gif" alt="Cargando..." />
        </div>

        <div id="mensajeExito">
            ‚úÖ Consulta realizada con √©xito.
        </div>

        <div id="mensajeError">
            ‚ùå Error en la consulta. Int√©ntalo de nuevo.
        </div>

        <div id="resultado"></div>
    </main>

    <script>
        document.getElementById('tipoConsulta').addEventListener('change', function () {
            let tipo = this.value;
            document.getElementById('fecha-container').style.display = (tipo === 'dia') ? 'block' : 'none';
            document.getElementById('mes-container').style.display = (tipo === 'mes') ? 'block' : 'none';
        });

        // Funci√≥n para realizar fetch con timeout
        async function fetchConTimeout(url, timeout = 20000) { // 20 segundos
            const controlador = new AbortController();
            const id = setTimeout(() => controlador.abort(), timeout);

            try {
                let response = await fetch(url, { signal: controlador.signal });
                clearTimeout(id);
                return response;
            } catch (error) {
                console.error("üö® Timeout o error de red:", error);
                throw new Error("La consulta tard√≥ demasiado. Int√©ntalo de nuevo.");
            }
        }

        document.getElementById('consulta-form').addEventListener('submit', async function(event) {
            event.preventDefault();

            let tipo = document.getElementById('tipoConsulta').value;
            let url = '/api/consulta';

            document.getElementById('loadingIcon').style.display = 'block';
            document.getElementById('mensajeExito').style.display = 'none';
            document.getElementById('mensajeError').style.display = 'none';
            document.getElementById('resultado').innerHTML = '';

            try {
                if (tipo === 'dia') {
                    let fecha = document.getElementById('fecha').value;
                    if (!fecha) {
                        alert("Por favor, selecciona una fecha.");
                        return;
                    }
                    url += `?fecha=${fecha}`;
                } else {
                    let mes = document.getElementById('mes').value;
                    if (!mes) {
                        alert("Por favor, selecciona un mes.");
                        return;
                    }
                    let [anio, mesNum] = mes.split('-');
                    url += `?mes=${mesNum}&anio=${anio}`;
                }

                let response = await fetchConTimeout(url, 20000); // Esperar hasta 20 segundos
                let text = await response.text(); // Leer respuesta como texto

                console.log("üì• Respuesta sin procesar:", text);

                let data;
                try {
                    data = JSON.parse(text);
                } catch (error) {
                    console.error("‚ùå Error parseando JSON:", error);
                    document.getElementById('mensajeError').style.display = 'block';
                    document.getElementById('resultado').innerHTML = `<p style="color: red;">Error en la respuesta del servidor.<br>Respuesta cruda:<br>${text}</p>`;
                    return;
                }

                // Si la respuesta es v√°lida o contiene datos, mostrar mensaje de √©xito
                if (response.ok || data) {
                    console.log("‚úÖ Respuesta JSON recibida:", data);
                    document.getElementById('mensajeExito').style.display = 'block';
                    document.getElementById('resultado').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                } else {
                    console.error("‚ö†Ô∏è Error en la respuesta del servidor:", response.status, data);
                    document.getElementById('mensajeError').style.display = 'block';
                    document.getElementById('resultado').innerHTML = `<p style="color: red;">Error: ${data.error || "Error desconocido."}</p>`;
                }
            } catch (error) {
                console.error("‚ùå Error en la consulta:", error);
                document.getElementById('mensajeError').style.display = 'block';
                document.getElementById('resultado').innerHTML = `<p style="color: red;">${error.message}</p>`;
            } finally {
                document.getElementById('loadingIcon').style.display = 'none';
            }
        });
    </script>

    <%- include('partials/footer') %>
</body>
</html>
